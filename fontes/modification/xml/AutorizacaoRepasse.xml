<?xml version="1.0" encoding="ISO-8859-1"?>
<modification>
  <id>AutorizacaoRepasse</id>
  <name>Autorização de Repasse</name>
  <ecidade-version>2.3.39</ecidade-version>
  <file path='emp4_gerarslipRPC.php'>
    <operation>
      <search><![CDATA[/** [AutorizacaoRepasse] - Inicio */]]></search>
      <add position="after">
        <![CDATA[
  case 'autorizarRepasseFinanceiro':

    try {
      db_inicio_transacao();

      $aAutorizacoes = array();
      foreach ($oParam->solicitacoes as $iSolicitacao) {

        $oData = new DBDate(date('Y-m-d', db_getsession('DB_datausu')));
        $oSolicitacao = new SolicitacaoRepasseFinanceiro($iSolicitacao);
        $oInstituicao = InstituicaoRepository::getInstituicaoByCodigo(db_getsession('DB_instit'));
        $oAutorizacao = new AutorizacaoSolicitacaoRepasse();
        $oAutorizacao->setSolicitacao($oSolicitacao);
        $oAutorizacao->setInstituicao($oInstituicao);
        $oAutorizacao->setData($oData);

        if ($oSolicitacao->getTipo() == SolicitacaoRepasseFinanceiro::TIPO_REPASSE) {
          $oAutorizacao->setContaPagadora(new contaTesouraria($oParam->conta_pagadora));
        }

        $oAutorizacao->autorizar();
        $aAutorizacoes[] = $oAutorizacao->getCodigo();
      }

      $oRetorno->erro  = false;
      $oRetorno->autorizacoes = implode(',', $aAutorizacoes);
      db_fim_transacao(false);

    } catch (Exception $eErro) {

      db_fim_transacao(true);
      $oRetorno->erro = true;
      $oRetorno->mensagem = urlencode($eErro->getMessage());
    }
    echo json_encode($oRetorno);
    break;
          ]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[/** [CancelamentoRepasse] - Inicio */]]></search>
      <add position="after">
        <![CDATA[
  case 'cancelarAutorizacaoRepasseFinanceiro':

    try {

      db_inicio_transacao();

      $oSolicitacaoRepasse = new SolicitacaoRepasseFinanceiro();
      $oSolicitacaoRepasse->setCodigo($oParam->iSolicitacao);
      $oAutorizacaoSolicitacaoRepasse = $oSolicitacaoRepasse->buscarAutorizacao();
      $oAutorizacaoSolicitacaoRepasse->cancelar();

      $oRetorno->erro = false;
      db_fim_transacao(false);

    } catch (Exception $eErro) {

      db_fim_transacao(true);
      $oRetorno->erro     = true;
      $oRetorno->mensagem = urlencode($eErro->getMessage());
    }
    echo json_encode($oRetorno);
    break;
          ]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[/** [DevolucaoRepasse] - Inicio */]]></search>
      <add position="after">
        <![CDATA[
  case 'salvarDevolucaoRepasse':

    try {

      db_inicio_transacao();

      if (empty($oParam->iSolicitacao)) {
        throw new Exception("A Solicitação de Repasse não foi informada.");
      }

      $oSolicitacao = new SolicitacaoRepasseFinanceiro($oParam->iSolicitacao);
      $oDevolucao   = new DevolucaoRepasseFinanceiro($oSolicitacao, $oParam->nValor);
      if (!empty($oParam->aLiquidacoes)) {
        $oDevolucao->setNotasLiquidacao($oParam->aLiquidacoes);
      }
      $oRetorno->slip = $oDevolucao->devolver();
      $oRetorno->erro = false;

      db_fim_transacao(false);

    } catch (Exception $eErro) {

      db_fim_transacao(true);
      $oRetorno->erro     = true;
      $oRetorno->mensagem = urlencode($eErro->getMessage());
    }
    echo json_encode($oRetorno);
    break;
          ]]>
      </add>
    </operation>
  </file>

  <file path='func_sliptipovinculo.php'>
    <operation>
      <search><![CDATA["classes/db_slip_classe.php"]]></search>
      <add position="replace">
        <![CDATA[Modification::getFile("classes/db_slip_classe.php")]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[/** [Extensão] - [AutorizacaoRepasse] - Parte 2 */]]></search>
      <add position="after">
        <![CDATA[

  if ($iTipoOperacao == 13) {
	  $sTipoOperacao .= " and autorizacaorepasse.sequencial is null ";
	}

  if ($iTipoOperacao == 11) {
    $sTipoOperacao .= " and not exists(select * from plugins.devolucaosolicitacaorepasse where devolucaosolicitacaorepasse.slip = slip.k17_codigo) ";
  }

          ]]>
      </add>
    </operation>
  </file>

  <file path='classes/db_slip_classe.php'>
    <operation>
      <search><![CDATA[/** [Extensão] - [AutorizacaoRepasse] */]]></search>
      <add position="after">
        <![CDATA[
  $sql .= "  left join plugins.autorizacaorepasse on autorizacaorepasse.slip = slip.k17_codigo ";
          ]]>
      </add>
    </operation>
  </file>

  <file path='model/agendaPagamento.model.php'>
    <operation>
      <search><![CDATA[/* [Extensao] - Solicitacao Repasse */]]></search>
      <add position="after">
        <![CDATA[
    $sRecursos = ConfiguracaoRepasseFinanceiro::getRecursoLiquidacaoObrigatoria();
    $sAnexos   = ConfiguracaoRepasseFinanceiro::getAnexoLiquidacaoNaoObrigatoria();
    $aUnidades = ConfiguracaoRepasseFinanceiro::getFiltrosOrgaoUnidade();
    $aWhereRepasse = array();

    if (!empty($sRecursos)) {
      $aWhereRepasse[] = " o58_codigo not in ({$sRecursos}) ";
    }

    if (!empty($sAnexos)) {
      $aWhereRepasse[] = " o58_localizadorgastos in ({$sAnexos}) ";
    }

    if (!empty($aUnidades)) {

      $aUnidades = array_map(function($oItem) {
        return "({$oItem->orgao}, {$oItem->unidade})";
      }, $aUnidades);

      $aWhereRepasse[] = " (o58_orgao, o58_unidade) in (" . implode(", ", $aUnidades) . ") ";
    }

    if (!empty($aWhereRepasse)) {

      $oDaoRepasse = new cl_solicitacaorepasseempnota();
      $sWhereNotaRepasse  = "solicitacaorepasseempnota.empnota = e71_codnota ";
      $sWhereNotaRepasse .= "and solicitacaorepasseempnota.estornado = false ";
      $sSqlRepasse = $oDaoRepasse->sql_query_autorizacao("*", $sWhereNotaRepasse);
      $sWhere .= " and ((" . implode(" or ", $aWhereRepasse) . ") or exists($sSqlRepasse)) ";
    }
          ]]>
      </add>
    </operation>

    <!-- MODIFICACAO NATAL-->
    <operation>
      <search regex="true"><![CDATA[(sql_query_contas_vinculadas)]]></search>
      <add>
        <![CDATA[$1_natal]]>
      </add>
    </operation>

  </file>
  
<!--                                          -->
<!-- INICIO DAS CUSTOMIZACOES EQUIPE NATAL/RN --> 
<!--                                          -->
  
  <file path='func_saltes.php'>
    <operation>
      <search regex="true"><![CDATA[(\$dbwhere\s*=\s*("|')\s*("|');)]]></search>
      <add>
        <![CDATA[$1

      if (isset($orgao) && isset($unidade)) {

        $oDepartOrg = new cl_db_departorg();
        $sSqlDepartOrg = $oDepartOrg->sql_query(null, null, "distinct db01_coddepto", null, "db01_orgao = $orgao and db01_unidade = $unidade");
        $rsDepartOrg   = $oDepartOrg->sql_record($sSqlDepartOrg);

        $aCodDepart = array();
        $aDepart = db_utils::getCollectionByRecord($rsDepartOrg);
        
        foreach ($aDepart as $depart) {
          $aCodDepart[] .= $depart->db01_coddepto;
        }

        $sDepart = implode(', ', $aCodDepart);
        $dbwhere .= " and k13_conta in (select saltes from plugins.saltesdepart where depart in (".$sDepart."))";
      }]]>
      </add>
    </operation>
  </file>

  <file path='classes/empenho.php'>
    <operation>
      <search regex="true"><![CDATA[(function.*estornaLiq.*\{)]]></search>
      <add>
        <![CDATA[$1
    if (SolicitacaoRepasseFinanceiro::notaTemSolicitacao($codnota)) {
      $this->lSqlErro  = true;
      $this->sMsgErro  = "Não é possível anular a nota {$codnota}. A nota está numa solicitação de repasse.";
    }]]>
      </add>
    </operation>

    <operation>
      <search regex="true"><![CDATA[(\(float\).*\$totalLiquidado.*(\n*.*)for.*count\(\$aNotas\).*\{)]]></search>
      <add>
        <![CDATA[$1
        if (SolicitacaoRepasseFinanceiro::notaTemSolicitacao($aNotas[$i])) {          
          $this->lSqlErro  = true;
          $this->sMsgErro  = "Não é possível anular a nota {$aNotas[$i]}. A nota está numa solicitação de repasse.";
        }]]>
      </add>
    </operation>
  </file>   

  <file path='classes/db_empagetipo_classe.php'>
    <operation>
      <search regex="true"><![CDATA[(function sql_query_contas_vinculadas\s*\(.*\{)]]></search>
      <add>
        <![CDATA[
  //inicio plugin GeracaoArquivoOBN      
  function sql_query_contas_vinculadas_natal ($e83_codtipo=null,$campos="*",$ordem=null,$sWhere, $lVinculadas = false) {
  
    $sSql = "select ";
    if($campos != "*" ){
        $campos_sql = split("#",$campos);
        $virgula = "";
        for($i=0;$i<sizeof($campos_sql);$i++){
            $sSql .= $virgula.$campos_sql[$i];
            $virgula = ",";
        }
    }else{
        $sSql .= $campos;
    }
    $sSql .= " from empagetipo ";
    $sSql .= "      left join (select distinct
                                     c61_reduz,
                                     C61_CODIGO,
                                     c61_anousu,
                                     e60_anousu
                                from empempenho
                                     inner join orcdotacao     on e60_coddot  = o58_coddot and e60_anousu = o58_anousu
                                     inner join conplanoreduz  on (c61_anousu = o58_anousu or c61_anousu = ".db_getsession("DB_anousu").")
                                                              and c61_codigo  = o58_codigo
                                     left join pagordem on e60_numemp       = e50_numemp
                                     left join saltes   on c61_reduz = k13_conta
                               where c61_instit=".db_getsession("DB_instit");
    if ($sWhere != '') {
        $sSql .= " and {$sWhere}";
    }
    $sSql .= " )";
    $sSql .= " as x on e83_conta = c61_reduz";
    $sSql .= " where c61_reduz is not null ";
  
    if (USE_PCASP) {
        $sSql .= " and c61_anousu = ".db_getsession("DB_anousu")." or c61_anousu = e60_anousu";
    }
  
    if ($lVinculadas) {
  
        $sSql .= " or e83_conta in ";
        $sSql .= " (select c61_reduz from conplanoreduz where c61_anousu =".db_getsession("DB_anousu");
        $sSql .= " and c61_codigo = 1 and c61_instit = ".db_getsession("DB_instit").")";
    }
  
    return $sSql;
  }
  //fim plugin GeracaoArquivoOBN
  
  $1]]>
      </add>
    </operation>
  </file>

</modification>
